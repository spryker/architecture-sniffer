#!/bin/bash

generate_package_summary() {
    (find . -name package.json -not -path '*/node_modules/*' -exec jq -r '.dependencies,.devDependencies | keys[] as $k | "\($k):\(.[$k])"' {} \; 2>/dev/null) | sort | uniq
}

generate_package_summary_to_file() {
   (generate_package_summary) > package-aggregated.txt
}

check_for_changes() {
    diff -q package-aggregated.txt <(generate_package_summary)
    return $?
}

main() {
    if [ "$#" -eq 0 ]; then
        generate_package_summary_to_file
        echo "Package summary generated in package-aggregated.txt ."
    elif [ "$1" = "--compare" ]; then
        if check_for_changes; then
            echo "No changes detected."
        else
            echo "Error: Package summary has changed. Run ./package-aggregator.sh locally to fix the error."
            exit 1
        fi
    else
        echo ""
        echo "Usage: $0 [--compare]"
        echo
        echo "The script traverses through the project directory structure, collecting dependencies and devDependencies"
        echo "from all package.json files, excluding those within node_modules directories."
        echo "The gathered dependencies are stored in the package-aggregated.txt file."
        echo
        echo "--compare This mode conducts a comparison between the generated dependency list (without saving)"
        echo "          and the existing package-aggregated.txt file. Any difference between the lists result in an error."
        echo ""
        exit 1
    fi
}

main "$@"
